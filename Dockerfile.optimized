FROM python:3.9-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DEBIAN_FRONTEND=noninteractive \
    PATH="/app:$PATH" \
    GEEKTIME_OUTPUT_DIR="/app/output" \
    GEEKTIME_CACHE_DIR="/app/cache" \
    GEEKTIME_TEMP_DIR="/app/temp"

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    libjpeg-dev \
    zlib1g-dev \
    libpng-dev \
    libffi-dev \
    libssl-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å‡çº§pip
RUN pip install --upgrade pip

# å®‰è£…åŸºç¡€Pythonä¾èµ–
RUN pip install --no-cache-dir \
    requests>=2.25.0 \
    termcolor \
    tqdm \
    "Pillow>=8.0.0" \
    "Jinja2>=3.0.0" \
    peewee \
    beautifulsoup4 \
    lxml

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY geektime_dl/ /app/geektime_dl/
COPY geektime.py /app/
COPY setup.py /app/

# æ‰‹åŠ¨å®‰è£…ebook-py
RUN pip install git+https://github.com/jachinlin/ebook-py.git

# åˆ›å»ºä¼˜åŒ–çš„ç›®å½•ç»“æ„
RUN mkdir -p /app/data /app/output /app/config /app/cache /app/temp

# åˆ›å»ºåº”ç”¨ç”¨æˆ·å¹¶è®¾ç½®æƒé™
RUN useradd --create-home --shell /bin/bash geektime && \
    chown -R geektime:geektime /app

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER geektime

# åˆ›å»ºgeektimeå‘½ä»¤è„šæœ¬
RUN echo '#!/usr/bin/env python' > /app/geektime && \
    echo 'import sys' >> /app/geektime && \
    echo 'sys.path.insert(0, "/app")' >> /app/geektime && \
    echo 'from geektime_dl import main' >> /app/geektime && \
    echo 'if __name__ == "__main__":' >> /app/geektime && \
    echo '    main()' >> /app/geektime && \
    chmod +x /app/geektime

# é…ç½®.bashrc
RUN echo 'export PATH="/app:$PATH"' >> ~/.bashrc && \
    echo 'export GEEKTIME_OUTPUT_DIR="/app/output"' >> ~/.bashrc && \
    echo 'export GEEKTIME_CACHE_DIR="/app/cache"' >> ~/.bashrc && \
    echo 'export GEEKTIME_TEMP_DIR="/app/temp"' >> ~/.bashrc && \
    echo 'export GEEKTIME_CONFIG="/app/config/geektime.cfg"' >> ~/.bashrc && \
    echo 'cd /app' >> ~/.bashrc && \
    echo '# GeekTime DL åˆ«åå’Œå‡½æ•°' >> ~/.bashrc && \
    echo 'alias gt="geektime"' >> ~/.bashrc && \
    echo 'alias ls="ls --color=auto"' >> ~/.bashrc && \
    echo 'alias ll="ls -la"' >> ~/.bashrc && \
    echo '# å¿«é€Ÿå‡½æ•°' >> ~/.bashrc && \
    echo 'gq() { geektime query --config /app/config/geektime.cfg --auth-type token --no-login "$@"; }' >> ~/.bashrc && \
    echo 'ge() { geektime ebook "$@" --config /app/config/geektime.cfg --auth-type token --no-login; }' >> ~/.bashrc

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash' > /app/entrypoint.sh && \
    echo 'echo "ğŸ“ æ¬¢è¿ä½¿ç”¨ GeekTime DL ä¼˜åŒ–ç‰ˆå®¹å™¨!"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ¯ å½“å‰é…ç½®:"' >> /app/entrypoint.sh && \
    echo 'echo "  é…ç½®æ–‡ä»¶: ${GEEKTIME_CONFIG}"' >> /app/entrypoint.sh && \
    echo 'echo "  è¾“å‡ºç›®å½•: ${GEEKTIME_OUTPUT_DIR}"' >> /app/entrypoint.sh && \
    echo 'echo "  ç¼“å­˜ç›®å½•: ${GEEKTIME_CACHE_DIR}"' >> /app/entrypoint.sh && \
    echo 'echo "  ä¸´æ—¶ç›®å½•: ${GEEKTIME_TEMP_DIR}"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ“‹ å¯ç”¨å‘½ä»¤:"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime query           | gq        # æŸ¥è¯¢è¯¾ç¨‹åˆ—è¡¨"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime ebook 48        | ge 48     # ä¸‹è½½è¯¾ç¨‹48"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime login           |           # ç™»å½•"' >> /app/entrypoint.sh && \
    echo 'echo "  gt query                 |           # ä½¿ç”¨åˆ«åæŸ¥è¯¢"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ“ ç›®å½•ç»“æ„:"' >> /app/entrypoint.sh && \
    echo 'echo "  /app/output -> å®¿ä¸»æœº ./output (æœ€ç»ˆæ–‡ä»¶)"' >> /app/entrypoint.sh && \
    echo 'echo "  /app/cache  -> å®¿ä¸»æœº ./cache (ç¼“å­˜æ–‡ä»¶)"' >> /app/entrypoint.sh && \
    echo 'echo "  /app/temp   -> å®¹å™¨å†… (ä¸´æ—¶æ–‡ä»¶)"' >> /app/entrypoint.sh && \
    echo 'echo "  /app/data   -> å®¿ä¸»æœº ./data (å¤‡ä»½æ•°æ®)"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ’¡ ç¤ºä¾‹:"' >> /app/entrypoint.sh && \
    echo 'echo "  gq                                    # æŸ¥è¯¢è¯¾ç¨‹"' >> /app/entrypoint.sh && \
    echo 'echo "  ge 48 --comments-count 50            # ä¸‹è½½è¯¾ç¨‹48ï¼ŒåŒ…å«50æ¡è¯„è®º"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸš€ è¾“å…¥ exit é€€å‡ºå®¹å™¨ï¼Œæˆ–å¼€å§‹ä½¿ç”¨å‘½ä»¤..."' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'exec /bin/bash' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

# è®¾ç½®å…¥å£ç‚¹
ENTRYPOINT ["/app/entrypoint.sh"]