FROM python:3.9-slim

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV PYTHONUNBUFFERED=1 \
    PYTHONDONTWRITEBYTECODE=1 \
    DEBIAN_FRONTEND=noninteractive

# å®‰è£…ç³»ç»Ÿä¾èµ–
RUN apt-get update && apt-get install -y \
    build-essential \
    libjpeg-dev \
    zlib1g-dev \
    libpng-dev \
    libffi-dev \
    libssl-dev \
    git \
    && rm -rf /var/lib/apt/lists/*

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /app

# å‡çº§pip
RUN pip install --upgrade pip

# å®‰è£…åŸºç¡€Pythonä¾èµ–
RUN pip install --no-cache-dir \
    requests>=2.25.0 \
    termcolor \
    tqdm \
    "Pillow>=8.0.0" \
    "Jinja2>=3.0.0" \
    peewee \
    beautifulsoup4 \
    lxml

# å¤åˆ¶åº”ç”¨ä»£ç 
COPY geektime_dl/ /app/geektime_dl/
COPY geektime.py /app/
COPY setup.py /app/

# æ‰‹åŠ¨å®‰è£…ebook-py
RUN pip install git+https://github.com/jachinlin/ebook-py.git

# æ‰‹åŠ¨åˆ›å»ºgeektimeå‘½ä»¤è„šæœ¬
RUN echo '#!/usr/bin/env python' > /app/geektime && \
    echo 'import sys' >> /app/geektime && \
    echo 'sys.path.insert(0, "/app")' >> /app/geektime && \
    echo 'from geektime_dl import main' >> /app/geektime && \
    echo 'if __name__ == "__main__":' >> /app/geektime && \
    echo '    main()' >> /app/geektime && \
    chmod +x /app/geektime

# åˆ›å»ºæ•°æ®ç›®å½•
RUN mkdir -p /app/data /app/config /app/cache

# åˆ›å»ºåº”ç”¨ç”¨æˆ·å¹¶è®¾ç½®æƒé™
RUN useradd --create-home --shell /bin/bash geektime && \
    chown -R geektime:geektime /app

# åˆ‡æ¢åˆ°åº”ç”¨ç”¨æˆ·
USER geektime

# åˆ›å»º.bashrcé…ç½®æ–‡ä»¶
RUN echo 'export PATH="/app:$PATH"' >> ~/.bashrc && \
    echo 'export GEEKTIME_CONFIG="/app/config/geektime.cfg"' >> ~/.bashrc && \
    echo 'export GEEKTIME_DATA_DIR="/app/data"' >> ~/.bashrc && \
    echo 'export GEEKTIME_CACHE_DIR="/app/cache"' >> ~/.bashrc && \
    echo 'cd /app' >> ~/.bashrc

# åˆ›å»ºä¾¿æ·çš„åˆ«å
RUN echo 'alias geektime="python -m geektime_dl"' >> ~/.bashrc

# åˆ›å»ºå¯åŠ¨è„šæœ¬
RUN echo '#!/bin/bash' > /app/entrypoint.sh && \
    echo 'echo "ğŸ“ GeekTime DL Container is ready!"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ“‹ Available commands:"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime query           # æŸ¥è¯¢è¯¾ç¨‹åˆ—è¡¨"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime ebook 48        # ä¸‹è½½è¯¾ç¨‹48"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime login           # ç™»å½•"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime help            # æ˜¾ç¤ºå¸®åŠ©"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ“ Directory mapping:"' >> /app/entrypoint.sh && \
    echo 'echo "  Data:     /app/data  -> \${PWD}/data"' >> /app/entrypoint.sh && \
    echo 'echo "  Config:   /app/config -> \${PWD}/config"' >> /app/entrypoint.sh && \
    echo 'echo "  Cache:    /app/cache  -> \${PWD}/cache"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸ’¡ Example usage:"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime query --config /app/config/geektime.cfg --auth-type token --no-login"' >> /app/entrypoint.sh && \
    echo 'echo "  geektime ebook 48 --config /app/config/geektime.cfg --auth-type token --no-login --comments-count 50"' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo 'echo "ğŸš€ Container is running... Press Ctrl+C to stop."' >> /app/entrypoint.sh && \
    echo 'echo ""' >> /app/entrypoint.sh && \
    echo '# ä¿æŒå®¹å™¨è¿è¡Œ' >> /app/entrypoint.sh && \
    echo 'tail -f /dev/null' >> /app/entrypoint.sh && \
    chmod +x /app/entrypoint.sh

# è®¾ç½®å…¥å£ç‚¹
ENTRYPOINT ["/app/entrypoint.sh"]